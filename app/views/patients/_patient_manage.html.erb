<!--<h1>Listing patients</h1>-->
<style>
    .ui-pg-input{
        height:30px;
    }
    .select2-container{
        width:200px;

    }
</style>
<div id="search_div" style="margin:10px;">
  医院：<select  id="patient_hos_id" onchange="pat_search_hos()" >
  <option value="">---请选择---</option>
  <% if !@hospitals.empty? && !@hospitals.nil?  %>
      <% @hospitals.each do |hos| %>
          <option id='search_hos_<%= hos.id %>' value="<%= hos.id %>"><%= hos.name %></option>
      <% end %>
  <% end %>
</select>
  科室：<span id="search_dep_id"><select id="patient_dep" onchange="pat_search_dep()" >
  <option value="all">---请选择---</option>
  <% if !@departments.nil? && !@departments.empty? %>
      <% @departments.each do |hos| %>
          <option id='serach_dep_<%= hos.id %>' value="<%= hos.id %>"><%= hos.name %></option>
      <% end %>
  <% end %>
</select></span>
  是否激活:<select id="is_activated" onchange="search_activated()">
  <option value="">全部</option>
  <option value="1">已经激活</option>
  <option value="0">未激活</option>
</select>
</div>

<table id="list10"></table>
<div id="pager10"></div>

<script>
    var row_id;
    var selectedIds  = jQuery("#list10").jqGrid("getGridParam","selarrrow");
    jQuery("#list10").jqGrid({
        url: "/patients/show_index",
        datatype: "json",
        height: "auto",
        colNames:['姓名', '证件类型','证件号码', '性别','出生日期','出生地','省','市','医院','科室','手机号','邮箱','最后就诊时间'],
        colModel:[
//            {name:'act',index:'act', width:75,sortable:false},
//            {name:'id',index:'id', width:120, sorttype:"int"},
            {name:'name',index:'name', width:55},
            {name:'credential_type',index:'credential_type', width:100},
            {name:'credential_type_number',index:'credential_type_number', width:180},
            {name:'gender',index:'gender', width:40},
            {name:'birthday',index:'birthday', width:90},
            {name:'birthplace',index:'birthplace', width:80},
            {name:'province_name',index:'province_name', width:100},
            {name:'city_name',index:'city_name', width:100},
            {name:'hospital_id',index:'hospital_id', width:100},
            {name:'department_id',index:'department_id', width:100},
            {name:'mobile_phone',index:'mobile_phone', width:100, align:"right",sorttype:"float"},
            {name:'email',index:'email', width:130, align:"right",sorttype:"float"},
            {name:'last_treat_time',index:'last_treat_time', width:80,align:"right",sorttype:"float"}
//            {name:'introduction',index:'introduction', width:260, sortable:false}
        ],
        pager: jQuery('#pager10'),
        sortname: 'id',
//        loadurl:"disable",
//        treeGrid:true,
        ExpandColumn: "menu",
        autowidth: true,
        rowNum: 20,
        rowList:[10,20,30,40],
        altRows: true,
        ignoreCase: true,
        onSelectRow: function(id){
            selectedIds  = jQuery("#list10").jqGrid("getGridParam","selarrrow");
        },

        viewrecords: true,
        multiselect: true,
        caption: "患者列表"
    });
    var selectedIds  = jQuery("#list10").jqGrid("getGridParam","selarrrow");
    jQuery("#list10").jqGrid('navGrid','#pager10',{edit:false,add:false,del:false,search:false});
    $("#list10").navButtonAdd('#pager10', {position: 'last', title: '添加', caption: '添加',id:'addPatient', onClickButton: createPatient})
    $("#list10").navButtonAdd('#pager10', {position: 'last', title: '删除', caption: '删除',id:'delete', onClickButton: deletePatient})
    $("#list10").navButtonAdd('#pager10', {position: 'last', title: '编辑', caption: '编辑',id:'edit', onClickButton: editPatient})
    $("#list10").navButtonAdd('#pager10', {position: 'last', title: '邮箱激活', caption: '邮箱激活',id:'sendEmailPatient', onClickButton: sendEmailPatient})
    $("#list10").navButtonAdd('#pager10', {position: 'last', title: '手机激活', caption: '手机激活',id:'sendPhonePatient', onClickButton: sendPhonePatient})

//    添加患者
    function createPatient(){
        $.ajax({
            type:'get',
            url:'/patients/new?hos_id=' + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val(),
            success:function(data){
                $('#create_or_edit_form2').html(data)

            }
        })
        $('#create_or_edit_form2').modal('show')
    }

//    编辑患者
    function editPatient(){
        if (selectedIds.length==1){
            $.ajax({
                type:'get',
                url:'/patients/'+selectedIds+'/edit?hos_id=' + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val(),
                success:function(data){
                    $('#create_or_edit_form2').html(data)
                }
            })
            $('#create_or_edit_form2').modal('show')
        }else{
            alert('必须且只能选择一条记录!')
        }
    }
// 删除患者
    function deletePatient(){
        if(confirm("确定要删除吗？") ) {
            $.ajax({
                type: 'delete',
                url: '/patients/' + selectedIds,
                success: function (data) {
                    if (data['success']) {
                        alert('删除成功!')
                    } else {
                        alert('删除失败!')
                    }
                }
            })
        }
        var url= "/patients/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val()
        jQuery("#list10").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    }

//    发送邮箱激活码
    function sendEmailPatient(){
        if (selectedIds.length>0) {
            $.ajax({
                type: 'get',
                url: '/patients/send_email?pat_ids=' + selectedIds,
                success: function (data) {
                    if (data['success']) {
                        alert('发送成功!')
                    } else {
                        alert('发送失败!如果是多个,可能部分发送成功!')
                    }
                }
            })
        }else{
            alert('请至少选择一条记录!')
        }
        var url= "/patients/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val()
        jQuery("#list10").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    }
//    发送手机激活码
    function sendPhonePatient(){
        if (selectedIds.length>0) {
            $.ajax({
                type:'get',
                url:'/patients/send_phone?pat_ids='+selectedIds,
                success:function(data){
                    if (data['success']){
                        alert('发送成功!')
                    }else {
                        alert('发送失败!如果是多个,可能部分发送成功!')
                    }

                }
            })
        }else{
            alert('请至少选择一条记录!')
        }
        var url= "/patients/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val()
        jQuery("#list10").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    }

    function pat_search_hos(){
        $('#is_edit').removeAttr("checked");
        $('#is_del').removeAttr("checked");
        $('#is_edit').removeAttr("disabled");
        $('#is_del').removeAttr("disabled");
        var hos_id = $('#patient_hos_id').val()
        $.ajax({
            type: 'get',
            url: '/patients/search_department?hos_id='+hos_id,
            success: function (data) {
                $('#search_dep_id').html(data)
            }
        });
        jQuery("#list10").jqGrid('setGridParam', {url: "/patients/show_index?hos_id=" + $('#patient_hos_id').val() +  "&is_activated=" + $('#is_activated').val() }).trigger("reloadGrid")
    }
    function pat_search_dep(){
        jQuery("#list10").jqGrid('setGridParam', {url: "/patients/show_index?hos_id=" + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val()  + "&is_activated=" + $('#is_activated').val() }).trigger("reloadGrid")
    }
    function search_activated(){
        jQuery("#list10").jqGrid('setGridParam', {url: "/patients/show_index?hos_id=" + $('#patient_hos_id').val() + "&dep_id=" + $('#patient_dep').val()  + "&is_activated=" + $('#is_activated').val()+"&priority_ids="+priority_ids }).trigger("reloadGrid")
    }
    $(function() {
        $("#patient_hos_id").select2();
        $("#patient_dep").select2();
        $("#is_activated").select2();
    })
</script>
<div class="modal fade" id="create_or_edit_form2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

</div>
