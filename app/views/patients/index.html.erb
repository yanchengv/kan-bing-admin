<!--<h1>Listing patients</h1>-->
<style>
    .ui-pg-input{
        height:30px;
    }
</style>
<div style="margin:10px;">
  <a id="create_patient" class="btn btn-primary btn-sm active" role="button">添加患者</a>
  <a id="edit_patient" class="btn btn-default btn-sm disabled" role="button">编辑患者</a>
  <a id="delete_patient" class="btn btn-default btn-sm disabled" role="button">删除患者</a>
  <a id="send_email_patient" class="btn btn-default btn-sm disabled" role="button">发送邮箱激活码</a>
  <a id="send_phone_patient" class="btn btn-default btn-sm disabled" role="button">发送手机激活码</a>
</div>
<table id="list10"></table>
<div id="pager10"></div>

<script>
    var row_id;
    var selectedIds  = jQuery("#list10").jqGrid("getGridParam","selarrrow");
    jQuery("#list10").jqGrid({
        url: "/patients?menu_id=<%=@menu_id%>",
        datatype: "json",
        height: "auto",
        colNames:['姓名', '证件类型','证件号码', '性别','出生日期','出生地','省','市','医院','科室','手机号','邮箱','最后就诊时间'],
        colModel:[
//            {name:'act',index:'act', width:75,sortable:false},
//            {name:'id',index:'id', width:120, sorttype:"int"},
            {name:'name',index:'name', width:55},
            {name:'credential_type',index:'credential_type', width:100},
            {name:'credential_type_number',index:'credential_type_number', width:180},
            {name:'gender',index:'gender', width:40},
            {name:'birthday',index:'birthday', width:90},
            {name:'birthplace',index:'birthplace', width:80},
            {name:'province_name',index:'province_name', width:100},
            {name:'city_name',index:'city_name', width:100},
            {name:'hospital_id',index:'hospital_id', width:100},
            {name:'department_id',index:'department_id', width:100},
            {name:'mobile_phone',index:'mobile_phone', width:100, align:"right",sorttype:"float"},
            {name:'email',index:'email', width:130, align:"right",sorttype:"float"},
            {name:'last_treat_time',index:'last_treat_time', width:80,align:"right",sorttype:"float"},
//            {name:'introduction',index:'introduction', width:260, sortable:false}
        ],
        pager: jQuery('#pager10'),
        sortname: 'id',
//        loadurl:"disable",
//        treeGrid:true,
        ExpandColumn: "menu",
        autowidth: true,
        rowNum: 20,
        rowList:[10,20,30,40],
        altRows: true,
        ignoreCase: true,
//        onSortCol: function(name,index){ alert("Column Name: "+name+" Column Index: "+index);},
//        ondblClickRow: function(id){ alert("You double click row with id: "+id);},
        onSelectRow: function(id){
            selectedIds  = jQuery("#list10").jqGrid("getGridParam","selarrrow");
            row_id = id
            $.ajax({
                type:'get',
                url:'/patients/is_executable?id='+selectedIds+'&menu_id=<%=@menu_id%>',
                success:function(data){
                    if (data['is_manage']) {
                        $('#edit_patient').removeClass('disabled')
                        $('#edit_patient').addClass('active')
                        $('#delete_patient').removeClass('disabled')
                        $('#delete_patient').addClass('active')
                    }
                    if (data['is_edit']) {
                        $('#edit_patient').removeClass('disabled')
                        $('#edit_patient').addClass('active')
                    }
                    if (data['is_delete']) {
                        $('#delete_patient').removeClass('disabled')
                        $('#delete_patient').addClass('active')
                    }
                    var selected_ids = ''+selectedIds
                    if (selected_ids.split(',').length>0 && data['is_activated']) {
                        $('#send_email_patient').removeClass('disabled')
                        $('#send_email_patient').addClass('active')
                        $('#send_phone_patient').removeClass('disabled')
                        $('#send_phone_patient').addClass('active')
                    }
                    if(selected_ids.split(',')[0]==''){
                        $('#edit_patient').removeClass('active')
                        $('#edit_patient').addClass('disabled')
                        $('#delete_patient').removeClass('active')
                        $('#delete_patient').addClass('disabled')
                        $('#send_email_patient').removeClass('active')
                        $('#send_email_patient').addClass('disabled')
                        $('#send_phone_patient').removeClass('active')
                        $('#send_phone_patient').addClass('disabled')
                    }
                    if (selected_ids.split(',').length>1){
                        $('#edit_patient').removeClass('active')
                        $('#edit_patient').addClass('disabled')
                    }
                }
            })
        },
        gridComplete: function(){
            if(selectedIds){
                var selected_ids = ''+selectedIds
                if (selected_ids.split(',')[0]!=''){
                    for(var i=0; i<selected_ids.split(',').length;i++){
                        $(this).jqGrid("setSelection",selected_ids.split(',')[i]);
                    }
                }
            }
        },
        viewrecords: true,
//        sortorder: "desc",
//        editurl:"",
        multiselect: true,
        caption: "患者列表"
    });
    jQuery("#list10").jqGrid('navGrid','#pager10',{edit:false,add:false,del:false});
    $( "#create_patient" ).button().on( "click", function() {
        $.ajax({
            type:'get',
            url:'/patients/new?&menu_id=<%=@menu_id%>',
            success:function(data){
                $('#create_or_edit_form2').html(data)

            }
        })
        $('#create_or_edit_form2').modal('show')
    });
    $( "#edit_patient").button().on( "click", function() {
        $.ajax({
            type:'get',
            url:'/patients/'+selectedIds+'/edit?menu_id=<%=@menu_id%>',
            success:function(data){
                $('#create_or_edit_form2').html(data)
            }
        })
        $('#create_or_edit_form2').modal('show')
    });
    $( "#delete_patient").button().on( "click", function() {
        if(confirm("确定要删除吗？") ) {
            $.ajax({
                type: 'delete',
                url: '/patients/' + selectedIds + '?menu_id=<%=@menu_id%>',
                success: function (data) {
                    if (data['success']) {
                        alert('删除成功!')
                    } else {
                        alert('删除失败!')
                    }
                }
            })
        }
//        $('#create_or_edit_form2').modal('show')
        var url= "/patients?menu_id=<%=@menu_id%>"
        jQuery("#list10").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
//        $('#refresh_list10').click()
    });
    $( "#send_email_patient").button().on( "click", function() {
        $.ajax({
            type:'get',
            url:'/patients/send_email?pat_ids='+selectedIds+'&menu_id=<%=@menu_id%>',
            success:function(data){
                if (data['success']){
                    alert('发送成功!')
                }else {
                    alert('发送失败!如果是多个,可能部分发送成功!')
                }
            }
        })
        var url= "/patients?menu_id=<%=@menu_id%>"
        jQuery("#list10").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    });
    $( "#send_phone_patient").button().on( "click", function() {
        $.ajax({
            type:'get',
            url:'/patients/send_phone?pat_ids='+selectedIds+'&menu_id=<%=@menu_id%>',
            success:function(data){
                if (data['success']){
                    alert('发送成功!')
                }else {
                    alert('发送失败!如果是多个,可能部分发送成功!')
                }

            }
        })
        var url= "/patients?menu_id=<%=@menu_id%>"
        jQuery("#list10").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    });
</script>
<div class="modal fade" id="create_or_edit_form2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

</div>
<!--<table>-->
  <!--<thead>-->
    <!--<tr>-->
      <!--<th>Id</th>-->
      <!--<th>Name</th>-->
      <!--<th>Spell code</th>-->
      <!--<th>Credential type</th>-->
      <!--<th>Credential type number</th>-->
      <!--<th>Gender</th>-->
      <!--<th>Birthday</th>-->
      <!--<th>Birthplace</th>-->
      <!--<th>Address</th>-->
      <!--<th>Nationality</th>-->
      <!--<th>Citizenship</th>-->
      <!--<th>Province</th>-->
      <!--<th>County</th>-->
      <!--<th>Photo</th>-->
      <!--<th>Marriage</th>-->
      <!--<th>Mobile phone</th>-->
      <!--<th>Home phone</th>-->
      <!--<th>Home address</th>-->
      <!--<th>Contact</th>-->
      <!--<th>Contact phone</th>-->
      <!--<th>Home postcode</th>-->
      <!--<th>Email</th>-->
      <!--<th>Introduction</th>-->
      <!--<th>Patient ids</th>-->
      <!--<th>Education</th>-->
      <!--<th>Household</th>-->
      <!--<th>Occupation</th>-->
      <!--<th>Orgnization</th>-->
      <!--<th>Orgnization address</th>-->
      <!--<th>Insurance type</th>-->
      <!--<th>Insurance number</th>-->
      <!--<th>patient</th>-->
      <!--<th>P user</th>-->
      <!--<th>Wechat</th>-->
      <!--<th>Last treat time</th>-->
      <!--<th>Diseases type</th>-->
      <!--<th>Is public</th>-->
      <!--<th>Childbirth date</th>-->
      <!--<th>Scan code</th>-->
      <!--<th>Height</th>-->
      <!--<th>Verify code</th>-->
      <!--<th>Is activated</th>-->
      <!--<th>Is checked</th>-->
      <!--<th>Verify code prit count</th>-->
      <!--<th>Province</th>-->
      <!--<th>City</th>-->
      <!--<th colspan="3"></th>-->
    <!--</tr>-->
  <!--</thead>-->

  <!--<tbody>-->
    <!--<%# @patients.each do |patient| %>-->
      <!--<tr>-->
        <!--<td><%#= patient.id %></td>-->
        <!--<td><%#= patient.name %></td>-->
        <!--<td><%#= patient.spell_code %></td>-->
        <!--<td><%#= patient.credential_type %></td>-->
        <!--<td><%#= patient.credential_type_number %></td>-->
        <!--<td><%#= patient.gender %></td>-->
        <!--<td><%#= patient.birthday %></td>-->
        <!--<td><%#= patient.birthplace %></td>-->
        <!--<td><%#= patient.address %></td>-->
        <!--<td><%#= patient.nationality %></td>-->
        <!--<td><%#= patient.citizenship %></td>-->
        <!--<td><%#= patient.province %></td>-->
        <!--<td><%#= patient.county %></td>-->
        <!--<td><%#= patient.photo %></td>-->
        <!--<td><%#= patient.marriage %></td>-->
        <!--<td><%#= patient.mobile_phone %></td>-->
        <!--<td><%#= patient.home_phone %></td>-->
        <!--<td><%#= patient.home_address %></td>-->
        <!--<td><%#= patient.contact %></td>-->
        <!--<td><%#= patient.contact_phone %></td>-->
        <!--<td><%#= patient.home_postcode %></td>-->
        <!--<td><%#= patient.email %></td>-->
        <!--<td><%#= patient.introduction %></td>-->
        <!--<td><%#= patient.patient_ids %></td>-->
        <!--<td><%#= patient.education %></td>-->
        <!--<td><%#= patient.household %></td>-->
        <!--<td><%#= patient.occupation %></td>-->
        <!--<td><%#= patient.orgnization %></td>-->
        <!--<td><%#= patient.orgnization_address %></td>-->
        <!--<td><%#= patient.insurance_type %></td>-->
        <!--<td><%#= patient.insurance_number %></td>-->
        <!--<td><%#= patient.patient_id %></td>-->
        <!--<td><%#= patient.p_user_id %></td>-->
        <!--<td><%#= patient.wechat %></td>-->
        <!--<td><%#= patient.last_treat_time %></td>-->
        <!--<td><%#= patient.diseases_type %></td>-->
        <!--<td><%#= patient.is_public %></td>-->
        <!--<td><%#= patient.childbirth_date %></td>-->
        <!--<td><%#= patient.scan_code %></td>-->
        <!--<td><%#= patient.height %></td>-->
        <!--<td><%#= patient.verify_code %></td>-->
        <!--<td><%#= patient.is_activated %></td>-->
        <!--<td><%#= patient.is_checked %></td>-->
        <!--<td><%#= patient.verify_code_prit_count %></td>-->
        <!--<td><%#= patient.province_id %></td>-->
        <!--<td><%#= patient.city_id %></td>-->
        <!--<td><%#= link_to 'Show', patient %></td>-->
        <!--<td><%#= link_to 'Edit', edit_patient_path(patient) %></td>-->
        <!--<td><%#= link_to 'Destroy', patient, method: :delete, data: { confirm: 'Are you sure?' } %></td>-->
      <!--</tr>-->
    <!--<%# end %>-->
  <!--</tbody>-->
<!--</table>-->

<br>

<%#= link_to 'New Patient', new_patient_path %>
