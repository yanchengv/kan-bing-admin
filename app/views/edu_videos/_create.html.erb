<style>
    input,select{
        display: block; margin-top: 1em;
    }
    .bar {
        height: 18px;
        background: green;
    }

    #progress1,#progress2 {
        width: 600px;
        background: #f5f5f5;
        /*box-sizing: border-box;*/
    }
</style>
<%= form_for @video,url:{action: 'upload', controller:'edu_videos'},:html => {:id => 'myForm',:multipart => true,:style => 'margin-left:20px;margin-top:-90px;'} do |f|%>
    <%= f.file_field :image, id:'fileupload',style:'visibility:hidden;'%>
    <%= f.file_field :video_url,id:'videoupload',style:'visibility:hidden;',onChange:'getFileName(this)'%>
    <%= f.text_field :image_url, id:'image_path',style:'visibility:hidden;' %>
    <table class="EditTable">
      <tr class="FormData">
        <td class="CaptionTD">视频名称:</td>
        <td class="DataTD"><%= f.text_field :name, :class => 'FormElement ui-widget-content ui-corner-all' %></td>
      </tr>
      <tr class="FormData">
        <td class="CaptionTD">概要:</td>
        <td class="DataTD"><%= f.text_field :content, :class => 'FormElement ui-widget-content ui-corner-all' %></td>
      </tr>
      <tr class="FormData">
        <td class="CaptionTD">医生:</td>
        <td class="DataTD"><select name="video[doctor_id]" style="width:172px;height:22px;" class="select2-container FormElement ui-widget-content ui-corner-all">
          <% if !@doctors.nil? %>
              <% hospitals_array = @doctors.map { |hospital| [hospital.name, hospital.id] } %>
              <option value="">请选择</option>
              <%= options_for_select(hospitals_array) %>
          <% end %>
        </select></td>
      </tr>
      <tr class="FormData">
        <td class="CaptionTD">时间:</td>
        <td class="DataTD"><%= f.date_field :video_time, id: 'video_time', style: 'width:172px;height:22px;' %></td>
      </tr>
      <tr class="FormData">
        <td class="CaptionTD">视频类型:</td>
        <td class="DataTD">
          <% types_array = @types.map { |type| [type.type_name, type.id] } %>
          <select name="edu_video[video_type]" style="width:172px;height:22px;" class="select2-container FormElement ui-widget-content ui-corner-all">
            <option value="">请选择</option><%= options_for_select(types_array) %></select></td>
      </tr>
      <tr class="FormData">
        <td class="CaptionTD">缩略图:</td>
        <td class="DataTD">
          <input id="image_path2" type="text" disabled="disabled" class='FormElement ui-widget-content ui-corner-all' style="display:inline"/><input id="fakebtn1" style="display:inline" type="button" value="选择图片文件"/>
         </td>
      </tr>
      <tr class="FormData">
        <td class="CaptionTD">视频:</td>
        <td class="DataTD">
          <input id="video_path" type="text" disabled="disabled" class='FormElement ui-widget-content ui-corner-all' style="display:inline"/><input id="fakebtn2" type="button" value="选择视频文件" style="display:inline"/>
        </td>
      </tr>
      <tr class="FormData">
        <td colspan="2">
          <div id="progress2">
            <div class="bar" style="width: 0%;"></div>
          </div>
        </td>
      </tr>
      <tr class="FormData">
        <td colspan="2">
          <div id="upload_div" style="display:inline;margin-left: 10px;"></div>
        </td>
      </tr>
    </table>

<%end%>

<script>
    function getFileName(obj)
    {
        var pos = obj.value.lastIndexOf("/")*1;
        var filepath = obj.value.substring(pos+1);
        var pos2 = filepath.lastIndexOf("\\")*1;
        var filename = filepath.substring(pos2+1);
        $('#video_path').val(filename)
        $('#progress2 .bar').css(
                'width',
                '0%'
        );
    }
    $("#fakebtn1").click(function () {
        $("#fileupload").click();
    });
    $("#fakebtn2").click(function () {
        $("#videoupload").click();
    });
    var ChunkCount = 0;
    var stime;
        var url1 = "/edu_videos/upload_image";
        var url2 = "/edu_videos/upload"
        $('#fileupload').fileupload({
            autoUpload: true,
            url: url1,
            dataType: 'json',
            //forceIframeTransport: true,
            maxChunkSize: 100000000, //100Mb
            fail:function (e, data) {
                console.log(data.errorThrown);
                alert('上传失败！')
            },

            done: function (e, data) {
                if (data.result.flag){
                   $('#image_path').val(data.result.url);
                   $('#image_path2').val(data.result.url);
                }
            }
        });
        $('#videoupload').fileupload({
            url: url2,
            dataType: 'json',
            //forceIframeTransport: true,
            maxChunkSize: 100000000000, //100Gb
            add: function (e, data) {
                $("#uploadinfo").remove();
                $('#progress .bar').css(
                        'width',
                        '0%'
                );
                $("#upload_div").html(data.context = $('<button/>').text('上传')
                        .appendTo(document.body)
                        .click(function () {
                            data.context = $('<p id="uploadinfo"></p>').text('正在上传...').replaceAll($(this));
                            var d = new Date();
                            data.submit();
                            stime = d.getTime();
                        }));
                ChunkCount = 0;
                $('#pausebtn').click(function(){
                    data.abort();
                });
                $('#resumebtn').click(function(){

                    data.uploadedBytes = 100000*ChunkCount;
                    data.data = null;
                    data.submit();

                });
            },
            fail:function (e, data) {
                alert('上传失败！')
                console.log(data.errorThrown);
            },
            done: function (e, data) {
                data.context = $("#uploadinfo").text('上传完成.')
                document.getElementById("myForm").reset()
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress2 .bar').css(
                        'width',
                        progress + '%'
                );
            }

        });

</script>