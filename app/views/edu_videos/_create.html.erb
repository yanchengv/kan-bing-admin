<%= link_to '教育视频列表', '/edu_videos' %>
<style>
    input,select{
        display: block; margin-top: 1em;
    }
    .bar {
        height: 18px;
        background: green;
    }

    #progress1,#progress2 {
        width: 600px;
        background: #f5f5f5;
        /*box-sizing: border-box;*/
    }
</style>
<%= form_for @video,url:{action: 'upload', controller:'edu_videos'},:html => {:id => 'myForm',:multipart => true,:style => 'margin-top:-60px;'} do |f|%>
    <%= f.file_field :image, id:'fileupload',style:'visibility:hidden;'%>
    <%= f.file_field :video_url,id:'videoupload',style:'visibility:hidden;',onChange:'getFileName(this)'%>
    <%= f.text_field :image_url, id:'image_path',style:'visibility:hidden;' %>
   视频名称: <%= f.text_field :name%><br/>
   概要:    <%= f.text_field :content%><br/>
   医生:<%#= f.text_field :doctor_name%>
    <select  name="video[doctor_id]" style="width:153px;height:22px;">
      <% if !@doctors.nil? %>
      <% hospitals_array = @doctors.map { |hospital| [hospital.name, hospital.id] } %>
      <option value="" >请选择</option>
      <%= options_for_select(hospitals_array) %>
      <% end %>
    </select><br/>
   时间:<%= f.date_field :video_time ,id:'video_time', style: 'width:153px;height:22px;'%> <br/>
    <% types_array = @types.map { |type| [type.type_name, type.id] } %>
   视频类型:<select name="edu_video[video_type]" style="width:153px;height:22px;"><option value="" >请选择</option><%= options_for_select(types_array) %></select> <br/>
   缩略图:<br/><input id="image_path2" type="text" disabled="disabled" style="display:inline"/><input id="fakebtn1"  style="display:inline" type="button" value="选择图片文件"/><br/>
    <!--<div id="progress1">-->
      <!--<div class="bar" style="width: 0%;"></div>-->
    <!--</div>-->
   视频:<br/><input id="video_path" type="text" disabled="disabled" style="display:inline" /><input id="fakebtn2" type="button" value="选择视频文件" style="display:inline" /><br/>
    <div id="progress2">
      <div class="bar" style="width: 0%;"></div>
    </div>
    <%#= current_admin %>
    <%#= current_admin.email %>
    <%#= current_admin.id %>

    <%= f.submit '保存'%>
<%end%>

<script>
    function getFileName(obj)
    {
        var pos = obj.value.lastIndexOf("/")*1;
        var filepath = obj.value.substring(pos+1);
        var pos2 = filepath.lastIndexOf("\\")*1;
        var filename = filepath.substring(pos2+1);
        $('#video_path').val(filename)
        $('#progress2 .bar').css(
                'width',
                '0%'
        );
    }
    $("#fakebtn1").click(function () {
        alert("#fakebtn1");
        $("#fileupload").click();
    });
    $("#fakebtn2").click(function () {

        $("#videoupload").click();
    });
    var ChunkCount = 0;
    var stime;
    $(function () {
        'use strict';
        var url1 = "/edu_videos/upload_image";
        var url2 = "/edu_videos/upload"
        $('#fileupload').fileupload({
            autoUpload: true,
            url: url1,
            dataType: 'json',
            //forceIframeTransport: true,
            maxChunkSize: 100000000, //100Mb
            fail:function (e, data) {
                console.log(data.errorThrown);
                alert('上传失败！')
            },

            done: function (e, data) {
                if (data.result.flag){
                   $('#image_path').val(data.result.url)
                   $('#image_path2').val(data.result.url)
                }
            }
//            progressall: function (e, data) {
//                var progress = parseInt(data.loaded / data.total * 100, 10);
//                $('#progress1 .bar').css(
//                        'width',
//                        progress + '%'
//                );
//            }

        });
        $('#videoupload').fileupload({
            url: url2,
            dataType: 'json',
            //forceIframeTransport: true,
            maxChunkSize: 100000000000, //100Gb
            add: function (e, data) {
                $("#uploadinfo").remove();
                $('#progress .bar').css(
                        'width',
                        '0%'
                );
                //data.files[0].name

                data.context = $('<button/>').text('确定')
                        .appendTo(document.body)
                        .click(function () {
                            data.context = $('<p id="uploadinfo"></p>').text('正在上传...').replaceAll($(this));
                            var d = new Date();
                            data.submit();
                            stime = d.getTime();
                        });
                ChunkCount = 0;
                $('#pausebtn').click(function(){
                    data.abort();
                });
                $('#resumebtn').click(function(){

                    data.uploadedBytes = 100000*ChunkCount;
                    data.data = null;
                    data.submit();

                });
            },
            fail:function (e, data) {
                alert('上传失败！')
                console.log(data.errorThrown);
            },
            done: function (e, data) {
                data.context = $("#uploadinfo").text('上传完成.')
                document.getElementById("myForm").reset()
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress2 .bar').css(
                        'width',
                        progress + '%'
                );
            }

        });

    });
</script>