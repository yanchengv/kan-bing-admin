<div style="width: 100%">
  <div style="margin-left: 20px;margin-right: 20px;">
    <div style="margin-bottom: 10px;">医生名：<input type="text" id="doc_name">
      <button id="search_ships_btn">搜索</button>&nbsp;<button id="clear_ships_btn">清空</button>
    </div>

    <table id="list_doctors_ships"></table>
    <div id="page_docs"></div>
  </div>
</div>

<script type="text/javascript">
    //搜索
    $('#search_ships_btn').click(function () {
        var name = $('#doc_name').val();
        jQuery("#list_doctors_ships").jqGrid('setGridParam', {url: "/doctor_friendships/index_show?name=" + name}).trigger("reloadGrid")
    });
    //清空
    $('#clear_ships_btn').click(function () {
        $('#doc_name').val('');
    });
    jQuery("#list_doctors_ships").jqGrid({
        url: '/doctor_friendships/index_show',
        datatype: "json",
        autowidth:true,
        height: 'auto',
        colNames: ['ID', '医生1所属省ID', '医生1所属市ID', '医生1所属医院ID', '医生1所属科室ID','医生1ID', '医生1', '医生2所属省ID', '医生2所属市ID', '医生2所属医院ID', '医生2所属科室ID','医生2ID', '医生2'],
        colModel: [
            {name: 'id', index: 'id', editable: true, hidden: true, align: "center"},
            {name: 'province1_id', index: 'province1_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions = {'':'---请选择---'};
                        $.ajax({
                            url: "/doctor_friendships/get_provinces",
                            async: false,
                            success: function (data) {
                                console.log(data.provinces);
                                positions.push(data.provinces);
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_cities?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['cities']) {
                                        if (data['cities'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['cities'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#city1_id").html(res);
                                }); // end get
                                $.get('/doctor_friendships/get_hospitals?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['hospitals']) {
                                        if (data['hospitals'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['hospitals'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#hospital1_id").html(res);
                                });
                                $.get('/doctor_friendships/get_departments?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['departments']) {
                                        if (data['departments'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#department1_id").html(res);
                                });
                            }

                        }
                    ]} },
            {name: 'city1_id', index: 'city1_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_cities",
                            async: false,
                            success: function (data) {
                                positions = data.cities;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var province_id = $("#province1_id").val();
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_hospitals?province_id='+ province_id +'&city_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['hospitals']) {
                                        if (data['hospitals'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['hospitals'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#hospital1_id").html(res);
                                });
                                $.get('/doctor_friendships/get_departments?province_id=' + province_id + '&city_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['departments']) {
                                        if (data['departments'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#department1_id").html(res);
                                });
                            }
                        }
                    ]} },
            {name: 'hospital1_id', index: 'hospital1_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_hospitals",
                            async: false,
                            success: function (data) {
                                positions = data.hospitals;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var province_id = $("#province1_id").val();
                                var city_id = $("#city1_id").val();
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_departments?province_id=' + province_id + '&city_id=' + city_id + '&hospital_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['departments']) {
                                        if (data['departments'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#department1_id").html(res);
                                });
                                $.get('/doctor_friendships/get_doctors?hospital_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['doctors']) {
                                        if (data['doctors'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['doctors'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#doctor1_id").html(res);
                                });
                            }
                        }
                    ]} },
            {name: 'department1_id', index: 'department1_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_departments",
                            async: false,
                            success: function (data) {
                                positions = data.departments;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var hospital_id = $("#hospital1_id").val();
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_doctors?hospital_id=' + hospital_id + '&department_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['doctors']) {
                                        if (data['doctors'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['doctors'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#doctor1_id").html(res);
                                });
                            }
                        }
                    ]} },
            {name: 'doctor1_id', index: 'doctor1_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_doctors",
                            async: false,
                            success: function (data) {
                                positions = data.doctors;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    }}},
            {name: 'doctor1_name', index: 'doctor1_name', align: "center", jsonmap: 'doctor1.name'},
            {name: 'province2_id', index: 'province2_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_provinces",
                            async: false,
                            success: function (data) {
                                positions = data.provinces;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_cities?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['cities']) {
                                        if (data['cities'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['cities'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#city2_id").html(res);
                                }); // end get
                                $.get('/doctor_friendships/get_hospitals?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['hospitals']) {
                                        if (data['hospitals'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['hospitals'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#hospital2_id").html(res);
                                });
                                $.get('/doctor_friendships/get_departments?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['departments']) {
                                        if (data['departments'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#department2_id").html(res);
                                });
                            }

                        }
                    ]} },
            {name: 'city2_id', index: 'city2_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_cities",
                            async: false,
                            success: function (data) {
                                positions = data.cities;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var province_id = $("#province2_id").val();
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_hospitals?province_id=' + province_id + '&city_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['hospitals']) {
                                        if (data['hospitals'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['hospitals'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#hospital2_id").html(res);
                                });
                                $.get('/doctor_friendships/get_departments?province_id=' + province_id + '&city_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['departments']) {
                                        if (data['departments'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#department2id").html(res);
                                });
                            }
                        }
                    ]} },
            {name: 'hospital2_id', index: 'hospital2_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_hospitals",
                            async: false,
                            success: function (data) {
                                positions = data.hospitals;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var province_id = $("#province2_id").val();
                                var city_id = $("#city2_id").val();
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_departments?province_id=' + province_id + '&city_id=' + city_id + '&hospital_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['departments']) {
                                        if (data['departments'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#department2_id").html(res);
                                });
                                $.get('/doctor_friendships/get_doctors?hospital_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['doctors']) {
                                        if (data['doctors'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['doctors'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#doctor2_id").html(res);
                                });
                            }
                        }
                    ]} },
            {name: 'department2_id', index: 'department2_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_departments",
                            async: false,
                            success: function (data) {
                                positions = data.departments;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var hospital_id = $("#hospital2_id").val();
                                var thisval = $(e.target).val();
                                $.get('/doctor_friendships/get_doctors?hospital_id=' + hospital_id + '&department_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    res += '<option value="">---请选择---</option>';
                                    for (var k in data['doctors']) {
                                        if (data['doctors'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['doctors'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#doctor2_id").html(res);
                                });
                            }
                        }
                    ]} },
            {name: 'doctor2_id', index: 'doctor2_id', editable: true, hidden: true, jsonmap: 'doctor2.id', editrules: {edithidden: true}, align: "center", edittype: 'select',
                editoptions: {
                    dataInit: function (element) {
                        $(element).select2();
                    },
                    style: "width:166px",
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "/doctor_friendships/get_doctors",
                            async: false,
                            success: function (data) {
                                positions = data.doctors;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    }}
            },
            {name: 'doctor2_name', index: 'doctor2_name', jsonmap: 'doctor2.name', align: "center" }
        ],
        rowNum: 20,
        rowList: [8, 10, 20, 30],
        rownumbers: true,
        page: 1,
        pager: '#page_docs',
        sortname: 'id',
        viewrecords: true,
        sortorder: "desc",
        multiselect: true,
        caption: "医友关系管理",
        prmNames: {
            page: "page", // 表示请求页码的参数名称
            rows: "rows", // 表示请求行数的参数名称
            id: "id", // 表示当在编辑数据模块中发送数据时，使用的id的名称
            //   npage: null,
            totalrows: "totalrows", // 表示需从Server得到总共多少行数据的参数名称，参见jqGrid选项中的rowTotal
            editoper: "edit", // 当在edit模式中提交数据时，操作的名称
            addoper: "add", // 当在add模式中提交数据时，操作的名称
            deloper: "del", // 当在delete模式中提交数据时，操作的名称
            subgridid: "id" // 当点击以载入数据到子表时，传递的数据名称
        },
        editurl: '/doctor_friendships/oper_action',
        jsonReader: {
            root: "doctor_friendships",
            total: "totalpages",
            page: "currpage",
            records: "totalrecords",
            repeatitems: false
        }
    });
    jQuery("#list_doctors_ships").jqGrid('navGrid', '#page_docs', {
                cloneToTop: true, addtext: "新增", addtitle: "新增", edittext: "编辑", edittitle: "编辑",
                deltext: "删除", deltitle: "删除", view: true, viewtext: "查看", viewtitle: "查看", search: false,
                refreshtext: "更新", refreshtitle: "更新"},
            {
                closeAfterEdit: true
            },//edit
            {
                closeAfterAdd: true
            }//add
    ).navButtonAdd('#page_docs', { title: '批量删除', caption: '批量删除', onClickButton: function () {
                batch_delete()
            }, position: "last"});
    //批量删除
    function batch_delete() {
        var ids = $('#list_doctors_ships').jqGrid('getGridParam', 'selarrrow');
        if (ids.length == 0) {
            alert('请选择删除项！');
        } else {
            $.ajax({
                        type: 'post',
                        url: '/doctor_friendships/batch_delete',
                        data: {ids: ids},
                        success: function (data) {
                            if (data.success == true) {
                                jQuery("#list_doctors_ships").jqGrid('setGridParam', {url: "/doctor_friendships/index_show"}).trigger("reloadGrid");
                            } else {
                                alert('操作失败！');
                            }
                        }
                    }
            );
        }
    }
</script>