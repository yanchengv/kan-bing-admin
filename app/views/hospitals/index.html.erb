<div style="width: 100%">
  <div style="width: 48%;float:left;margin-left: 20px;">
    <div style="margin-bottom: 10px;">医院名称：<input type="text" id="question_content">&nbsp;<a id="search_question_btn" class="btn btn-default btn-sm" role="button">搜索</a>
    </div>
    <table id="hospital_list"></table>
    <div id="page_hos"></div>
  </div>
  <div style="width: 48%;float:left;margin-left: 20px;">
    <div style="margin-bottom: 10px;">科室名称：<input type="text" id="result_content">&nbsp;<a id="search_result_btn" class="btn btn-default btn-sm" role="button">搜索</a>
    </div>
    <table id="department_list"></table>
    <div id="page_dept"></div>
  </div>
</div>

<script type="text/javascript">

    jQuery("#hospital_list").jqGrid({
        url: 'hospitals/index_show',
        datatype: "json",
        mtype: 'GET',
        colNames: [ 'ID', '名称', '简称', '省份', '省份ID', '城市ID', '城市', '地址', '等级', '邮箱', '运营模式', '网址', '传真', '特色科室', '描述'],
        colModel: [
            { name: 'id', index: 'id', align: "left", key: 'id', hidden: true },
            { name: 'name', index: 'name', align: "center", editable: true},
            { name: 'short_name', index: 'short_name', align: "center", editable: true},
            { name: 'province_name', index: 'province_name', align: "center", editable: false},
            { name: 'province_id', index: 'province_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select', formatter: 'select',
                editoptions: {
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "hospitals/get_provinces",
                            async: false,
                            success: function (data) {
                                positions = data.provinces;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    },
                    dataEvents: [
                        { type: 'change',
                            fn: function (e) {
                                var thisval = $(e.target).val();
                                alert(thisval);
                                $.get('hospitals/get_cities?province_id=' + thisval, function (data) {
                                    var res = '<select width=300>';
                                    for (var k in data['cities']) {
                                        if (data['cities'].hasOwnProperty(k)) {
                                            res += '<option value="' + k + '">' + data['cities'][k] + '</option> '
                                        }
                                    }
                                    res += '</select>';
                                    $("#city_id").html(res);
                                }); // end get
                            }

                        }
                    ]
                }
            },
            { name: 'city_id', index: 'city_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, edittype: 'select', formatter: 'select',
                editoptions: {
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "hospitals/get_cities",
                     //       data:{province_id: },
                            async: false,
                            success: function (data) {
                                positions = data.cities;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    }
                }
            },
            { name: 'city_name', index: 'city_name', align: "center", editable:  false},
            { name: 'address', index: 'address', align: "center", editable: true},
            { name: 'rank', index: 'rank', align: "center", editable: true, edittype: 'select', formatter: 'select',
                editoptions: {
                    value: function () {
                        var positions;
                        $.ajax({
                            url: "hospitals/get_ranks",
                            async: false,
                            success: function (data) {
                                positions = data.ranks;
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(textStatus);
                            }
                        });
                        return positions;
                    }
                }},
            { name: 'email', index: 'email', align: "center", editable: true, editrules: {email: true, required: false}},
            { name: 'operation_mode', index: 'operation_mode', align: "center", editable: true, edittype: 'select', editoptions:{value:"国有:国有;民营:民营"}},
            { name: 'hospital_site', index: 'hospital_site', align: "center", editable: true, editrules: {url: true, required: false}},
            { name: 'fax_number', index: 'fax_number', align: "center", editable: true},
            { name: 'key_departments', index: 'key_departments', align: "center", editable: true},
            { name: 'description', index: 'description', align: "center", editable: true, edittype: 'textarea'}
        ],
        rowList: [10, 20, 30],
        sortname: 'id',
        viewrecords: true,
        sortorder: "desc",
        autowidth: true,
        jsonReader: {
            root: "hospitals",
            total: "totalpages",
            page: "currpage",
            records: "totalrecords",
            repeatitems: false
        },
        onSelectRow: function (rowid) {
            jQuery("#department_list").jqGrid('setGridParam', {url: "departments/index_show?hospital_id=" + rowid }).trigger("reloadGrid");
        },
        prmNames: {
            page: "page", // 表示请求页码的参数名称
            rows: "rows", // 表示请求行数的参数名称
            id: "id", // 表示当在编辑数据模块中发送数据时，使用的id的名称
            //   npage: null,
            totalrows: "totalrows", // 表示需从Server得到总共多少行数据的参数名称，参见jqGrid选项中的rowTotal
            editoper: "edit", // 当在edit模式中提交数据时，操作的名称
            addoper: "add", // 当在add模式中提交数据时，操作的名称
            deloper: "del", // 当在delete模式中提交数据时，操作的名称
            subgridid: "id" // 当点击以载入数据到子表时，传递的数据名称
        },
        editurl: 'hospitals/oper_action',
        closeAfterAdd: true,
        pager: jQuery('#page_hos'),
       // multiselect: true,
        rowNum: 20,
        altclass: 'altRowsColour',
        width: '500',
        height: 'auto',
        caption: "医院管理"
    });
    jQuery("#hospital_list").jqGrid('navGrid', '#page_hos', {
                cloneToTop: true, addtext: "新增", addtitle: "新增", edittext: "编辑", edittitle: "编辑",
                deltext: "删除", deltitle: "删除",view: true, viewtext: "查看", viewtitle: "查看", search: false,
                refreshtext: "更新", refreshtitle: "更新"},
            {
                closeAfterEdit: true
            },//edit
            {
                closeAfterAdd: true
            }//add
             );
    //科室管理 //:id, :name, :, :spell_code,:, :, :, :, :, :
    jQuery("#department_list").jqGrid({
        url: 'departments/index_show',
        datatype: "json",
        mtype: 'GET',
        colNames: ['ID', '姓名', '简称', '电话', '医院ID', '科室类型','状态', '描述'],
        colModel: [
            { name: 'id', index: 'id', align: "left", key: 'id',hidden:true},
            { name: 'name', index: 'name', align: "center", editable: true},
            { name: 'short_name', index: 'short_name', align: "center", editable: true},
            { name: 'phone_number', index: 'phone_number', align: "center", editable: true},
            { name: 'hospital_id', index: 'hospital_id', align: "center", editable: true, editrules:{editable: false}},
            { name: 'department_type', index: 'department_type', align: "center", editable: true},
            { name: 'state', index: 'state', align: "center", editable: true},
          //  { name: 'sort', index: 'sort', align: "center", editable: true},
            { name: 'description', index: 'description', align: "center", editable: true, edittype: 'textarea'}
        ],
        rowList: [10, 20, 30],
        sortname: 'id',
        viewrecords: true,
        sortorder: "desc",
        autowidth: true,
        jsonReader: {
            root: "departments",
            total: "totalpages",
            page: "currpage",
            records: "totalrecords",
            repeatitems: false
        },
        prmNames: {
            page: "page", // 表示请求页码的参数名称
            rows: "rows", // 表示请求行数的参数名称
            id: "id", // 表示当在编辑数据模块中发送数据时，使用的id的名称
            //   npage: null,
            totalrows: "totalrows", // 表示需从Server得到总共多少行数据的参数名称，参见jqGrid选项中的rowTotal
            editoper: "edit", // 当在edit模式中提交数据时，操作的名称
            addoper: "add", // 当在add模式中提交数据时，操作的名称
            deloper: "del", // 当在delete模式中提交数据时，操作的名称
            subgridid: "id" // 当点击以载入数据到子表时，传递的数据名称
        },
        editurl: 'departments/oper_action',
        closeAfterAdd: true,
        pager: jQuery('#page_dept'),
     //   multiselect: true,
        rowNum: 20,
        altclass: 'altRowsColour',
        width: '500',
        height: 'auto',
        caption: "科室管理"
    });
    jQuery("#department_list").jqGrid('navGrid', '#page_dept', {
                cloneToTop: true, addtext: "新增", addtitle: "新增", edittext: "编辑", edittitle: "编辑",
                deltext: "删除", deltitle: "删除", view: true, viewtext: "查看", viewtitle: "查看", search: false,
                refreshtext: "更新", refreshtitle: "更新"},
            {
                closeAfterEdit: true
            },//edit
            {
                closeAfterAdd: true,
                beforeShowForm: function (frm) {
                    var id = jQuery("#hospital_list").jqGrid('getGridParam', 'selrow');
                   if(id){
                       $("#hospital_id").attr('value', id);
                   }else{
                       alert('请选择医院！');
                   }

                }
            }//add
            );
    //搜索咨询
    $('#search_question_btn').click(function () {
        var text = $('#question_content').val();
        jQuery("#hospital_list").jqGrid('setGridParam', {url: "consult_accuses/index_accuses?content=" + text }).trigger("reloadGrid")
    });
    //搜索回复
    $('#search_result_btn').click(function () {
        var text = $('#result_content').val();
        jQuery("#department_list").jqGrid('setGridParam', {url: "consult_accuses/index_results?content=" + text }).trigger("reloadGrid")
    });
</script>