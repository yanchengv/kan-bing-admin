<div style="width: 100%">
  <div style="margin-left: 20px;margin-right: 20px;">
  <div style="margin-bottom: 10px;">医院：<select id="patient_ship_hos"  style="width: 139px;">
    <option value="0">---请选择---</option>
    <% if !@hospitals.empty? %>
        <% @hospitals.each do |hos| %>
            <option id='hos_<%= hos.id %>' value="<%= hos.id %>"><%= hos.name %></option>
        <% end %>
    <% end %>
  </select>&nbsp;
    科室：<select id="patient_ship_dep" style="width: 139px;">
    <option value="0">---请选择---</option>
    <% if !@departments.empty? %>
        <% @departments.each do |dept| %>
            <option id='hos_<%= dept.id %>' value="<%= dept.id %>"><%= dept.name %></option>
        <% end %>
    <% end %>
  </select>&nbsp;医生名：<input type="text" id="doc_name">
    关联医生<input type="radio" name="state" value='true' onclick="search_state('true')" checked="checked"/>&nbsp;非关联医生<input type="radio" name="state" value="false" onclick="search_state('false')"/>
    <a id="search_ships_btn" class="btn btn-default btn-sm" role="button">搜索</a>
  </div>

    <table id="list_doc2pat_ships"></table>
    <div id="page_doc2pats"></div>
  </div>
</div>

<script type="text/javascript">
//状态搜索
    function search_state(bl) {
        jQuery("#list_doc2pat_ships").jqGrid('setGridParam', {url: "treatment_relationships/index_show?str=" + bl}).trigger("reloadGrid");
    }
//搜索
$('#search_ships_btn').click(function () {
    var hos_id = $('#patient_ship_hos').val();
    var department_id = $('#patient_ship_dep').val();
    var name = $('#doc_name').val();
    var states = document.getElementsByName("state");
    var state = '';
    for (var i = 0; i < states.length; i++) {
        if (states[i].checked) {
            state = states[i].value;
        }
    }
    jQuery("#list_doc2pat_ships").jqGrid('setGridParam', {url: "treatment_relationships/index_show?hospital_id=" + hos_id + "&department_id=" + department_id + "&name=" + name + '&str=' + state}).trigger("reloadGrid")
});
    $(function () {
        $("#patient_ship_hos").select2();
        $("#patient_ship_dep").select2();
    })
    $("#patient_ship_hos").on("change", function (event) {
        var hos_id = $('#patient_ship_hos').val();
        $.get('treatment_relationships/get_departments?hospital_id=' + hos_id, function (data) {
            var res = '<select width=300><option value="0">---全部---</option>';
            for (var k in data['departments']) {
                if (data['departments'].hasOwnProperty(k)) {
                    res += '<option value="' + k + '">' + data['departments'][k] + '</option> '
                }
            }
            res += '</select>';
            $("#patient_ship_dep").html(res);
        }); // end get
    });

    jQuery("#list_doc2pat_ships").jqGrid({
        url: 'treatment_relationships/index_show',
        datatype: "json",
        autowidth:true,
        height: 'auto',
        colNames: ['医生ID', '姓名', '性别', '医院', '科室'],
        colModel: [
            {name: 'id', index: 'id', sorttype: "int", align: "center"},
            {name: 'name', index: 'name',editable: true, align: "center" },
            {name: 'gender', index: 'gender', editable: true, align: "center" },
            {name: 'hospital_name', index: 'hospital_name', editable: true, jsonmap:'hospital.name', align: "center" },
            {name: 'department_name', index: 'department_name', editable: true, jsonmap:'department.name', align: "center" }
        ],
        rowNum: 20,
        rowList: [8, 10, 20, 30],
        pager: '#page_doc2pats',
        sortname: 'id',
        viewrecords: true,
        sortorder: "desc",
        multiselect: false,
        subGrid: true,
        caption: "医患关系管理",
        prmNames: {
            page: "page", // 表示请求页码的参数名称
            rows: "rows", // 表示请求行数的参数名称
            id: "id", // 表示当在编辑数据模块中发送数据时，使用的id的名称
            //   npage: null,
            totalrows: "totalrows", // 表示需从Server得到总共多少行数据的参数名称，参见jqGrid选项中的rowTotal
            editoper: "edit", // 当在edit模式中提交数据时，操作的名称
            addoper: "add", // 当在add模式中提交数据时，操作的名称
            deloper: "del", // 当在delete模式中提交数据时，操作的名称
            subgridid: "id" // 当点击以载入数据到子表时，传递的数据名称
        },
        editurl: 'treatment_relationships/oper_action',
        jsonReader: {
            root: "doctors",
            total: "totalpages",
            page: "currpage",
            records: "totalrecords",
            repeatitems: false
        },
        subGridRowExpanded: function (subgrid_id, row_id) {
            var subgrid_table_id, pager_id;
            subgrid_table_id = subgrid_id + "_t";
            pager_id = "p_" + subgrid_table_id;
            var doc = $('#list_doc2pat_ships').jqGrid('getRowData', row_id);
            $("#" + subgrid_id).html("<table id='" + subgrid_table_id + "' class='scroll'></table><div id='" + pager_id + "' class='scroll'></div>");
            jQuery("#" + subgrid_table_id).jqGrid({
                url: "treatment_relationships/get_patients?doctor_id=" + row_id,
                datatype: "json",
                colNames: ['ID','医生ID','医生姓名', '患者ID', '患者姓名', '患者性别'],// '患者医院', '患者科室' ],
                colModel: [
                    {name: 'id', index: 'id', editable: true, hidden:true, align: "center"},
                    {name: 'doctor_id', index: 'doctor_id', align: "center", editable: true, hidden: true, editrules: {edithidden: true}, editoptions: { defaultValue: doc.id, readonly: 'readonly'}},
                    {name: 'doctor_name', index: 'doctor_name', align: "center", editable: true, jsonmap: 'doctor.name', hidden: true, editrules: {edithidden: true}, editoptions: { defaultValue: doc.name, readonly: 'readonly'}},
                    {name: 'patient_id', index: 'patient_id', editable: true, align: "center", hidden: true, editrules: {edithidden: true}, edittype: 'select', formatter: 'select',
                        editoptions: {
                            style: "width:166px",
                            value: function () {
                                var positions;
                                $.ajax({
                                    url: "treatment_relationships/get_n_patients",
                                    data: {doctor_id: row_id},
                                    async: false,
                                    success: function (data) {
                                        positions = data.patients;
                                    },
                                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                                        alert(textStatus);
                                    }
                                });
                                return positions;
                            }}
                    },
                    {name: 'name', index: 'name', jsonmap: 'patient.name', align: "center" },
                    {name: 'gender', index: 'gender', jsonmap: 'patient.gender', align: "center" }//,
//                    {name: 'hospital_name', index: 'hospital_id', jsonmap: 'patient.hospital_name', align: "center"},
//                    {name: 'department_name', index: 'department_id', jsonmap: 'patient.department_name', align: "center"}
                ],
                rowNum: 10,
                pager: pager_id,
                sortname: 'num',
                sortorder: "asc",
                autowidth: true,
                height: 'auto',
                prmNames: {
                    page: "page", // 表示请求页码的参数名称
                    rows: "rows", // 表示请求行数的参数名称
                    id: "id", // 表示当在编辑数据模块中发送数据时，使用的id的名称
                    //   npage: null,
                    totalrows: "totalrows", // 表示需从Server得到总共多少行数据的参数名称，参见jqGrid选项中的rowTotal
                    editoper: "edit", // 当在edit模式中提交数据时，操作的名称
                    addoper: "add", // 当在add模式中提交数据时，操作的名称
                    deloper: "del", // 当在delete模式中提交数据时，操作的名称
                    subgridid: "id" // 当点击以载入数据到子表时，传递的数据名称
                },
                editurl: 'treatment_relationships/oper_action',
                multiselect: true,
                jsonReader: {
                    root: "treatment_relationships",
                    total: "totalpages",
                    page: "currpage",
                    records: "totalrecords",
                    repeatitems: false
                }
            });
            jQuery("#" + subgrid_table_id).jqGrid('navGrid', "#" + pager_id, {
                        cloneToTop: true, addtext: "新增", addtitle: "新增", edittext: "编辑", edittitle: "编辑", view: false,
                        deltext: "删除", deltitle: "删除", search: false,
                        refreshtext: "更新", refreshtitle: "更新"},
                    {
                        closeAfterEdit: true
                    },//edit
                    {
                        closeAfterAdd: true
                    }//add
            ).navButtonAdd('#' + pager_id, { title: '批量删除', caption: '批量删除', onClickButton: function () {
                        batch_delete(subgrid_table_id, row_id)
                    }, position: "last"})
        },
        subGridRowColapsed: function (subgrid_id, row_id) {
        }
    });
    jQuery("#list_doc2pat_ships").jqGrid('navGrid', '#page_doc2pats', {
                cloneToTop: true, add: false, edit:false, view:false,
                del:false, search: false,
                refreshtext: "更新", refreshtitle: "更新"}
             );
    //批量删除
    function batch_delete(id, rowId) {
        var ids = $('#' + id).jqGrid('getGridParam', 'selarrrow');
        if (ids.length == 0) {
            alert('请选择删除项！');
        } else {
            $.ajax({
                        type: 'post',
                        url: '/treatment_relationships/batch_delete',
                        data: {ids: ids},
                        success: function (data) {
                            if (data.success == true) {
                                jQuery("#" + id).jqGrid('setGridParam', {url: "treatment_relationships/get_patients?doctor_id=" + rowId}).trigger("reloadGrid");
                            } else {
                                alert('操作失败！');
                            }
                        }
                    }
            );
        }
    }
</script>