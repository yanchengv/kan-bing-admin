
<style>
    .ui-pg-input{
        height:30px;
    }
    .select2-container{
        width:200px;

    }
</style>
<!--<h1>Listing doctors</h1>-->
<div id="search_div" style="margin:10px;">
  医院：<select  id="doctor_hos_id" name="doctor_hos_id" onchange="doc_search_hos()" >
  <!--<option value="">---请选择---</option>-->
  <% if !@hospitals.nil? && !@hospitals.empty? %>
      <% @hospitals.each do |hos| %>
          <option id='serch_hos_<%= hos.id %>' value="<%= hos.id %>"><%= hos.name %></option>
      <% end %>
  <% end %>
</select>
  科室：<span id="search_dep_id"><select id="doctor_dep" name="doctor[department_id]" onchange="doc_search_dep()" >
  <% if params[:dep_id] == '' %>
    <option value="all">---请选择---</option>
  <% end %>
  <% if !@departments.nil? && !@departments.empty? %>
      <% @departments.each do |hos| %>
          <option id='serch_dep_<%= hos.id %>' value="<%= hos.id %>"><%= hos.name %></option>
      <% end %>
  <% end %>
</select></span>
  是否激活:<select id="is_activated" onchange="search_activated()">
  <option value="">全部</option>
  <option value="1">已经激活</option>
  <option value="0">未激活</option>
</select>
</div>
<form name="form1" method="post" action="" style="margin:10px;" >
  <input type="checkbox" name="checkbox" value="3" id="is_edit">可编辑

  <input type="checkbox" name="checkbox" value="2" id="is_del">可删除

</form>

<table id="list12"></table>
<div id="pager12"></div>

<script>
    $(function(){
        $("input:checkbox").bind('change',function(){
            if($(this).attr("checked"))
            {
                $(this).removeAttr("checked");
            }
            else
            {
                $(this).attr("checked",'true');   //你说的给文本框赋值可以在这里写
            }
            var str=""
            $("[name='checkbox'][checked]").each(function(){
                str+=$(this).val()+" "
            })
            var priority_ids = $.trim(str).split(" ")
           $('#deleteDoctor').remove();
            $('#updateDoctor').remove();
            for( var obj in priority_ids){
                if(priority_ids[obj]==2){
                    $("#list12").navButtonAdd('#pager12', {position: 'last', title: '删除', caption: '删除',id:'deleteDoctor', onClickButton: deleteDoctor});
                }
                if(priority_ids[obj]==3){
                    $("#list12").navButtonAdd('#pager12', {position: 'last', title: '修改', caption: '修改',id:'updateDoctor', onClickButton: updateDoctor});

                }
            }
            var url= "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id="+ $('#doctor_hos_id').val()+"&priority_ids="+priority_ids
            jQuery("#list12").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
        });
    });
    var lastSel = 0
    var row_id;
    var selectedIds  = jQuery("#list12").jqGrid("getGridParam","selarrrow");
    jQuery("#list12").jqGrid({
        url: "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=<%=@hos_id%>",
        datatype: "json",
        height: "auto",
        colNames:['ID','姓名', '证件类型','证件号码', '性别','出生日期','出生地','省','市','医院','科室','手机号','邮箱','职称'],
        colModel:[
//            {name:'act',index:'act', width:75,sortable:false},
            {name:'id',index:'id', width:120, sorttype:"int",search:false },
            {name:'name',index:'name', width:55, editable: true ,searchoptions: { sopt: ['eq']}},
            {name:'credential_type',index:'credential_type', width:100, editable: true ,edittype:"select",editoptions:{value:"身份证:身份证;其他:其他"},search:false },
            {name:'credential_type_number',index:'credential_type_number', width:180, editable: true ,searchoptions: { sopt: ['eq']}},
            {name:'gender',index:'gender', width:40, editable: true ,search:false },
            {name:'birthday',index:'birthday', width:90, editable: true ,search:false },
            {name:'birthplace',index:'birthplace', width:80, editable: true ,search:false },
            {name:'province_name',index:'province_name', width:100, editable: true,search:false  },
            {name:'city_name',index:'city_name', width:100, editable: true ,search:false },
            {name:'hospital_id',index:'hospital_id', width:100, editable: true,search:false  },
            {name:'department_id',index:'department_id', width:100, editable: true,search:false  },
            {name:'mobile_phone',index:'mobile_phone', width:100, align:"right", editable: true,searchoptions: { sopt: ['eq']} },
            {name:'email',index:'email', width:130, align:"right", editable: true ,searchoptions: { sopt: ['eq']}},
            {name:'professional_title',index:'professional_title', width:80,align:"right",editable: true,search:false }
//            {name:'introduction',index:'introduction', width:260, sortable:false}
        ],
        pager: jQuery('#pager12'),
        sortname: 'id',
//        loadurl:"disable",
//        treeGrid:true,
        ExpandColumn: "menu",
        autowidth: true,
        rowNum: 20,
        rowList:[10,20,30,40],
        altRows: true,
        ignoreCase: true,
        onSelectRow: function(id){
            selectedIds  = jQuery("#list12").jqGrid("getGridParam","selarrrow");
        },

        viewrecords: true,
        editurl:'/doctors/',
        multiselect: true,
        caption: "医生列表"
    });

    var selectedIds  = jQuery("#list12").jqGrid("getGridParam","selarrrow");
//    自定义按钮
    $("#list12").jqGrid('navGrid','#pager12',{edit:false,add:false,del:false,search:false,searchtext:"查找"});
    $("#list12").navButtonAdd('#pager12', {position: 'last', title: '添加', caption: '添加',id:'addDoctor', onClickButton: addDoctor});
    $("#list12").navButtonAdd('#pager12', {position: 'last', title: '邮箱激活', caption: '邮箱激活',id:'sendEmailDoctor', onClickButton: sendEmailDoctor});
    $("#list12").navButtonAdd('#pager12', {position: 'last', title: '手机激活', caption: '手机激活',id:'sendPhoneDoctor', onClickButton: sendPhoneDoctor});


//    添加医生
    function addDoctor(){
        $.ajax({
            type:'get',
            url:'/doctors/new?menu_id=<%=@menu_id%>&hos_id=' + $('#doctor_hos_id').val() + '&dep_id=' + $('#doctor_dep').val(),
            success:function(data){
                $('#create_or_edit_form').html(data)

            }
        })
        $('#create_or_edit_form').modal('show')
    };
// 删除医生
    function deleteDoctor(){
        if(confirm("确定要删除吗？") ) {
            $.ajax({
                type: 'delete',
                url: '/doctors/' + selectedIds + '',
                success: function (data) {
                    if (data['success']) {
                        alert('删除成功!')
                    } else {
                        alert('删除失败!')
                    }
                }
            })
        }
        var url= "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#doctor_hos_id').val() + '&dep_id=' + $('#doctor_dep').val()
        jQuery("#list12").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    };
// 修改医生
    function updateDoctor(){
        if (selectedIds.length==1){
            $.ajax({
                type:'get',
                url:'/doctors/'+selectedIds+'/edit?menu_id=<%=@menu_id%>&hos_id=' + $('#doctor_hos_id').val() + '&dep_id=' + $('#doctor_dep').val(),
                success:function(data){
                    $('#create_or_edit_form').html(data)
                }
            })
            $('#create_or_edit_form').modal('show')
        }else{
            alert('必须且只能选择一条记录!')
        }
    };

// 发送邮箱验证码
    function sendEmailDoctor(){
        if (selectedIds.length>0){
            $.ajax({
                type:'get',
                url:'/doctors/send_email?doc_ids='+selectedIds+'',
                success:function(data){
                    if (data['success']){
                        alert('发送成功!')
                    }else {
                        alert('发送失败!如果是多个,可能部分发送成功!')
                    }
                }
            })
        }else{
            alert('请至少选择一条记录!')
        }
        var url= "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#doctor_hos_id').val() + '&dep_id=' + $('#doctor_dep').val()
        jQuery("#list12").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    };
//    发送手机验证码
    function sendPhoneDoctor(){
        if (selectedIds.length>0){
            $.ajax({
                type:'get',
                url:'/doctors/send_phone?doc_ids='+selectedIds,
                success:function(data){
                    if (data['success']){
                        alert('发送成功!')
                    }else {
                        alert('发送失败!如果是多个,可能部分发送成功!')
                    }

                }
            })
        }else{
            alert('请至少选择一条记录!')
        }
        var url= "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#doctor_hos_id').val() + '&dep_id=' + $('#doctor_dep').val()
        jQuery("#list12").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
    };


    function doc_search_hos(){
        $('#is_edit').removeAttr("checked");
        $('#is_del').removeAttr("checked");
        $('#is_edit').removeAttr("disabled");
        $('#is_del').removeAttr("disabled");
        var hos_id = $('#doctor_hos_id').val()
        $.ajax({
            type: 'get',
            url: '/doctors/search_department?menu_id=<%=@menu_id%>&hos_id='+hos_id,
            success: function (data) {
                $('#search_dep_id').html(data)
            }
        })
        $.ajax({
                    type: "get",
                    url: '/doctors/is_permission?menu_id=<%=@menu_id%>&hospital_id=' + $('#doctor_hos_id').val() + '&department_id=',
                    data: 'text',
                    success: function (data) {
                        if (data['add']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '添加', caption: '添加',id:'addDoctor', onClickButton: addDoctor});
                        }else{
                           $('#addDoctor').remove();
                        }
                        if (data['delete']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '删除', caption: '删除',id:'deleteDoctor', onClickButton: deleteDoctor});

                        }else{
                            $('#deleteDoctor').remove();
                        }
                        if (data['update']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '修改', caption: '修改',id:'updateDoctor', onClickButton: updateDoctor});

                        }else{
                            $('#update').remove();
                        }
                        if (data['show']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '邮箱激活', caption: '邮箱激活',id:'sendEmailDoctor', onClickButton: sendEmailDoctor});
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '手机激活', caption: '手机激活',id:'sendPhoneDoctor', onClickButton: sendPhoneDoctor});

                        }else{
                            $('#sendEmailDoctor').remove();
                            $('#sendPhoneDoctor').remove();
                        }
                    }
                }
        );
        jQuery("#list12").jqGrid('setGridParam', {url: "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#doctor_hos_id').val()  + "&is_activated=" + $('#is_activated').val() }).trigger("reloadGrid")
    }
    function doc_search_dep(){
        $('#is_edit').removeAttr("checked");
        $('#is_del').removeAttr("checked");
        if ($('#doctor_dep').val()=='' || $('#doctor_dep').val()=='all'){
            $('#is_edit').removeAttr("disabled");
            $('#is_del').removeAttr("disabled");
        }else{
            $('#is_edit').attr("disabled",'true');
            $('#is_del').attr("disabled",'true');
        }
        jQuery("#list12").jqGrid('setGridParam', {url: "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#doctor_hos_id').val() + "&dep_id=" + $('#doctor_dep').val()  + "&is_activated=" + $('#is_activated').val() }).trigger("reloadGrid")
        $.ajax({
                    type: "get",
                    url: '/doctors/is_permission?menu_id=<%=@menu_id%>&hospital_id=' + $('#doctor_hos_id').val() + '&department_id=' + $('#doctor_dep').val(),
                    data: 'text',
                    success: function (data) {
                        if (data['add']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '添加', caption: '添加',id:'addDoctor', onClickButton: addDoctor});
                        }else{
                            $('#addDoctor').remove();
                        }
                        if (data['delete']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '删除', caption: '删除',id:'deleteDoctor', onClickButton: deleteDoctor});

                        }else{
                            $('#deleteDoctor').remove();
                        }
                        if (data['update']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '修改', caption: '修改',id:'updateDoctor', onClickButton: updateDoctor});

                        }else{
                            $('#updateDoctor').remove();
                        }

                        if (data['show']){
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '邮箱激活', caption: '邮箱激活',id:'sendEmailDoctor', onClickButton: sendEmailDoctor});
                            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '手机激活', caption: '手机激活',id:'sendPhoneDoctor', onClickButton: sendPhoneDoctor});

                        }else{
                            $('#sendEmailDoctor').remove();
                            $('#sendPhoneDoctor').remove();
                        }
                    }
                }
        );
    }
    function search_activated(){
        var str=""
        $("[name='checkbox'][checked]").each(function(){
            str+=$(this).val()+" "
        })
        var priority_ids = $.trim(str).split(" ")
        for( var obj in priority_ids){
            if(priority_ids[obj]==2){
                $('#delete_doctor').removeClass('disabled')
                $('#delete_doctor').addClass('active')
            }
            if(priority_ids[obj]==3){
                $('#edit_doctor').removeClass('disabled')
                $('#edit_doctor').addClass('active')
            }
        }
        jQuery("#list12").jqGrid('setGridParam', {url: "/doctors/show_index?menu_id=<%=@menu_id%>&hos_id=" + $('#doctor_hos_id').val() + "&dep_id=" + $('#doctor_dep').val()  + "&is_activated=" + $('#is_activated').val() + "&priority_ids=" + priority_ids }).trigger("reloadGrid")
        if ($('#is_activated').val()==1){
            $('#sendEmailDoctor').remove();
            $('#sendPhoneDoctor').remove();
//            $('#send_email_doctor').removeClass('active')
//            $('#send_email_doctor').addClass('disabled')
//            $('#send_phone_doctor').removeClass('active')
//            $('#send_phone_doctor').addClass('disabled')
        }else{
            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '邮箱激活', caption: '邮箱激活',id:'sendEmailDoctor', onClickButton: sendEmailDoctor});
            $("#list12").navButtonAdd('#pager12', {position: 'last', title: '手机激活', caption: '手机激活',id:'sendPhoneDoctor', onClickButton: sendPhoneDoctor});
//            $('#send_email_doctor').removeClass('disabled')
//            $('#send_email_doctor').addClass('active')
//            $('#send_phone_doctor').removeClass('disabled')
//            $('#send_phone_doctor').addClass('active')
        }
    }
    $(function() {
        $("#doctor_hos_id").select2();
        $("#doctor_dep").select2();
        $("#is_activated").select2();
        <% if !@hos.nil? %>
        $('#s2id_doctor_hos_id').children('.select2-choice').children('.select2-chosen').html('<%=@hos.name%>');
        document.getElementById("serch_hos_<%=@hos.id%>").setAttribute('selected','selected')
        <% end %>
        <% if !@dep.nil? %>
        $('#s2id_doctor_dep').children('.select2-choice').children('.select2-chosen').html('<%=@dep.name%>');
        document.getElementById("serch_dep_<%=@dep.id%>").setAttribute('selected','selected')
        <% end %>
//        $.ajax({
//                    type: "get",
//                    url: '/doctors/is_permission?menu_id=<%=@menu_id%>&hospital_id=' + $('#doctor_hos_id').val() + '&department_id=' + $('#doctor_dep').val(),
//                    data: 'text',
//                    success: function (data) {
//                        if (data['add']){
//                            $('#create_doctor').removeClass('disabled')
//                            $('#create_doctor').addClass('active')
//                        }else{
//                            $('#create_doctor').removeClass('active')
//                            $('#create_doctor').addClass('disabled')
//                        }
//                        if (data['delete']){
//                            $('#delete_doctor').removeClass('disabled')
//                            $('#delete_doctor').addClass('active')
//                        }else{
//                            $('#delete_doctor').removeClass('active')
//                            $('#delete_doctor').addClass('disabled')
//                        }
//                        if (data['update']){
//                            $('#edit_doctor').removeClass('disabled')
//                            $('#edit_doctor').addClass('active')
//                        }else{
//                            $('#edit_doctor').removeClass('active')
//                            $('#edit_doctor').addClass('disabled')
//                        }
//                        if (data['show']){
//                            $('#send_email_doctor').removeClass('disabled')
//                            $('#send_email_doctor').addClass('active')
//                            $('#send_phone_doctor').removeClass('disabled')
//                            $('#send_phone_doctor').addClass('active')
//                        }else{
//                            $('#send_email_doctor').removeClass('active')
//                            $('#send_email_doctor').addClass('disabled')
//                            $('#send_phone_doctor').removeClass('active')
//                            $('#send_phone_doctor').addClass('disabled')
//                        }
//                    }
//                }
//        );
    })
</script>
<div id="dialog-form" title="Create or edit user">
  <%#= render 'form' %>
</div>
<div class="modal fade" id="create_or_edit_form" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

</div>
